# Automated plotting of logged data

The Windows PC runs a group of LabView programs that control the dilution refrigerator and log the magnet temperatures as well as the DR pressures and temperatures.
On the machine is also a LabView program to visualize the data saved to the log files, but I wanted a way to follow the status of the equipment without being in the lab.

My solution is to use the Raspberry Pi (which can access both the PC and the internet, see [Network setup](NetworkSetup.md)) to automatically copy the logged data off the PC, plot it, and upload it to my website on the NBI server.

## Mounting the shared folder from the Windows PC

I have mounted the shared folder in ```/mnt/magnetlogs/```.
This is described in [Network setup](NetworkSetup.md).

## Copying the data

Before plotting the data, I copy the logs from the network folder to the local drive
```
rsync -avuh /mnt/magnetlogs/MMTest/* /home/pi/Data/Logfiles/
```
and use the local copy for the plotting.

I then copy the newest versions of each log file from ```Data/Logfiles/``` to ```Data/```, renaming them, so the plotting script can always find the files under their expected names:
```
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*Magnet.logtext | tail -1`" /home/pi/Data/magnetTemperatures.txt
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*DR.log | tail -1`" /home/pi/Data/DRlog.txt
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*.dat | tail -1`" /home/pi/Data/DRtemps.txt
```
This makes use of ```ls``` to get the name of the newest file matching a given pattern.

## Plotting the data

I use [gnuplot](http://gnuplot.info) for plotting and have made separate scripts for plotting the three logs.

[plotMagnetTemperatures.plt](Scripts/plotMagnetTemperatures.plt) plots the temperatures of the different components of the magnet cryocooler, as well as the inner and outer coils of the magnet.
[plotDRlog.plt](Scripts/plotDRlog.plt) plots the pressures in the helium system. 
[plotDRtemps.plt](Scripts/plotDRtemps.plt) plots the temperatures different places in the dilution refrigerator.

The output of these scripts are PNG files that are placed in the folder ```/home/pi/Data/Plots/```.

## Uploading to the website

I have a website set up at the NBI server, accessible through http://www.nbi.dk/~ljt123/.
There, I have put four HTML files showing the figures generated by gnuplot:
[index.html](Website/index.html), [magnet.html](Website/magnet.html), [DRtemps.html](Website/DRtemps.html) and [DRlog.html](Website/DRlog.html).

After all figures are generated, I upload them to the website using
```
rsync -vh /home/pi/Data/Plots/*.png myon:public_html/Figures/
```
where ```myon``` is the name I have given the server in my ```.ssh/config/``` file where I also specify the username.
Since the figures always have the same names, the site will now show the newest plots.
The command as shown will of course rely on me having placed the Pi's public key on the server, so authentication happens automatically.

## Script for copying, plotting and uploading

I assembled all of this into a script by the name of [runAll.sh](Scripts/runAll.sh), which includes all of the above commands, as well as commands printing the time and date the script is run.

The output of a successful run looks like this:
```
runAll.sh was started on: 2018-09-06 11:30:01

Copying logs from the Windows machine.
sending incremental file list
2018-08-31_DR.log
2018-08-31_Magnet.log
2018-08-31_Magnet.logtext
Temps_2018-08-31-14-33-44.dat

sent 11.05M bytes  received 92 bytes  1.16M bytes/sec
total size is 11.22M  speedup is 1.02

Plotting magnet temperatures.

Plotting DR pressure log.

Plotting DR temperatures.

Uploading plots to the website.
DRlogAll.png
DRlogDumps.png
DRlogPIVCStill.png
DRlogPs.png
DRtemps.png
DRtempsOhm.png
DRtempsOhmRecent.png
DRtempsRecent.png
magnetTempAll300K.png
magnetTempRecent004K.png
magnetTempRecent015K.png
magnetTempRecent300K.png
magnetTempRecentCoils.png

sent 416.22K bytes  received 5.21K bytes  280.95K bytes/sec
total size is 580.87K  speedup is 1.38

runAll.sh finished on: 2018-09-06 11:30:57

```

## Cronjob

In the crontab on the Pi, i have added the line
```
*/10 * * * * /home/pi/Data/runAll.sh > /home/pi/Data/cronLog.txt
```
which runs ```runAll.sh``` every ten minutes, and saves the output to ```cronLog.txt```, overwriting the file each time.

For this to work properly, I have made sure to give absolute paths in all scripts and commands.

## Copying the newest plots

If I want to follow the logs directly on another machine, I can run
```
rsync pi@kepler:Data/Plots/*.png .
```
to copy the figures to the current folder.
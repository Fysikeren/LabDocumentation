# Automated plotting of logged data

The Windows PC runs a group of LabView programs that control the dilution refrigerator and log the magnet temperatures as well as the DR pressures and temperatures.
On the machine is also a LabView program to visualize the data saved to the log files, but I wanted a way to follow the status of the equipment without being in the lab.

My solution is to use the Raspberry Pi (which can access both the PC and the internet, see [Network Setup](NetworkSetup.md)) to automatically copy the logged data off the PC, plot it, and upload it to my website on the NBI server.

## Mounting the shared folder from the Windows PC

I have mounted the shared folder in ```/mnt/magnetlogs/```.
This is described in [Network Setup](NetworkSetup.md).

## Copying the data

Before plotting the data, I copy the logs from the network folder to the local drive:
```
rsync -avuh /mnt/magnetlogs/MMTest/* /home/pi/Data/Logfiles/
```
and use the local copy for the plotting.

I then copy the newest versions of each log file from ```Data/Logfiles/``` to ```Data/```, renaming them, so the plotting script can always find the files under their expected names:
```
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*Magnet.logtext | tail -1`" /home/pi/Data/magnetTemperatures.txt
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*DR.log | tail -1`" /home/pi/Data/DRlog.txt
cp -p "`ls -dtr1 /home/pi/Data/Logfiles/*.dat | tail -1`" /home/pi/Data/DRtemps.txt
```
This makes use of ```ls``` to get the name of the newest file matching a given pattern.

## Plotting the data

I use [gnuplot](http://gnuplot.info) for plotting.

## Uploading to the website

I have a website set up at the NBI server, accessible through http://www.nbi.dk/~ljt123/.
There, I have put four HTML files showing the figures generated by gnuplot:
[Website/index.html], 

## Script for copying, plotting and uploading

I assembled all of this into a script by the name of ```runAll.sh```, which includes all of the above commands, as well as commands printing the time and date the script is run and 

The output of a successful run will look like this:
```
runAll.sh was started on: 2018-09-04 12:00:02

Copying logs from the Windows machine.
sending incremental file list
2018-08-31_DR.log
2018-08-31_Magnet.log
2018-08-31_Magnet.logtext
Temps_2018-08-31-14-33-44.dat

sent 7.46M bytes  received 92 bytes  1.66M bytes/sec
total size is 7.63M  speedup is 1.02

Plotting magnet temperatures.

Plotting DR pressure log.

Plotting DR temperatures.

Uploading plots to the website.
DRlogAll.png
DRlogDumps.png
DRlogPIVCStill.png
DRlogPs.png
DRtemps.png
DRtempsOhm.png
DRtempsOhmRecent.png
DRtempsRecent.png
magnetTempAll300K.png
magnetTempRecent004K.png
magnetTempRecent010K.png
magnetTempRecent300K.png
magnetTempRecentCoils.png

sent 458,647 bytes  received 5,483 bytes  928,260.00 bytes/sec
total size is 606,479  speedup is 1.31

runAll.sh finished on: 2018-09-04 12:00:46
```

## Cronjob

In the crontab on the Pi, i have added the line
```
*/10 * * * * /home/pi/Data/runAll.sh > /home/pi/Data/cronLog.txt
```
which runs ```runAll.sh``` every ten minutes, and saves the output to ```cronLog.txt```, overwriting the file each time.